# Lab 12: Tool Server Protocol

## Goal
Научиться реализовывать tool servers: протоколы stdio/HTTP, версионирование схем и архитектуру tool server.

## Theory

### Tool Servers

По мере роста агентов инструменты становятся сервисами:
- **Отдельные процессы** — Инструменты работают независимо
- **Протокольная коммуникация** — stdio или HTTP
- **Версионирование схем** — Обработка обновлений инструментов
- **Изоляция** — Инструменты изолированы для безопасности

### Зачем нужны Tool Servers?

**Монолитный агент (Lab 01-09):**
- Все инструменты в одном процессе
- Инструменты скомпилированы с агентом
- Сложно обновлять инструменты независимо

**Архитектура tool server (Lab 12):**
- Инструменты в отдельных процессах
- Инструменты можно обновлять без пересборки агента
- Лучшая безопасность (инструменты изолированы)
- Инструменты могут быть написаны на разных языках

### Протоколы

**stdio Protocol:**
- Простой: читать из stdin, писать в stdout
- Формат JSON request/response
- Хорошо для локальных инструментов

**HTTP Protocol:**
- REST API для выполнения инструментов
- Лучше для распределенных систем
- Можно вызывать из любого места

### Версионирование схем

Инструменты развиваются со временем:
- Версия 1.0: `check_status(hostname)`
- Версия 2.0: `check_status(hostname, timeout)` — добавлен параметр

**Стратегия версионирования:**
- Каждый инструмент имеет версию
- Агент указывает требуемую версию
- Tool server проверяет совместимость
- Возвращает ошибку, если версии не совпадают

См. подробнее: [Глава 18: Протоколы Инструментов и Tool Servers](../../book/18-tool-protocols-and-servers/README.md)

## Task

В `main.go` реализуйте tool server с поддержкой протоколов.

### Часть 1: stdio Protocol

Реализуйте `StdioToolServer`:
- Читайте запросы из stdin (формат JSON)
- Выполняйте инструменты
- Пишите ответы в stdout (формат JSON)

**Формат запроса:**
```json
{
  "tool": "check_status",
  "version": "1.0",
  "arguments": {"hostname": "web-01"}
}
```

**Формат ответа:**
```json
{
  "success": true,
  "result": "Server is ONLINE",
  "error": null
}
```

### Часть 2: HTTP Protocol

Реализуйте `HTTPToolServer`:
- HTTP endpoint для выполнения инструментов (POST /execute)
- Формат JSON request/response
- Обработка ошибок

**Endpoint:** `POST /execute`
**Тело запроса:**
```json
{
  "tool": "check_status",
  "version": "1.0",
  "arguments": {"hostname": "web-01"}
}
```

**Ответ:**
```json
{
  "success": true,
  "result": "Server is ONLINE",
  "error": null
}
```

### Часть 3: Версионирование схем

Реализуйте `ToolDefinition` с версионированием:
- Поле версии (например, "1.0", "2.0")
- Список совместимых версий
- Проверка версии перед выполнением

**Пример:**
```go
type ToolDefinition struct {
    Name            string
    Version         string
    CompatibleWith  []string  // ["1.0", "1.1", "2.0"]
    Description     string
    Parameters      json.RawMessage
}
```

### Часть 4: Интеграция с агентом

Реализуйте tool client на стороне агента:
- Вызывайте tool server через протокол (stdio или HTTP)
- Обрабатывайте совместимость версий
- Обработка ошибок

**Workflow агента:**
1. Агенту нужно вызвать инструмент
2. Агент отправляет запрос в tool server (с версией)
3. Tool server проверяет совместимость версий
4. Tool server выполняет инструмент
5. Tool server возвращает результат
6. Агент получает результат и продолжает

## Important

- Всегда проверяйте совместимость версий
- Корректно обрабатывайте ошибки протокола
- Поддерживайте оба протокола (stdio и HTTP)
- Инструменты должны быть изолированы (отдельные процессы)

## Completion Criteria

✅ **Сдано:**
- stdio протокол реализован
- HTTP протокол реализован
- Версионирование схем работает
- Агент может вызывать tool server
- Совместимость версий проверяется
- Обработка ошибок реализована

❌ **Не сдано:**
- Нет версионирования, обновления ломают совместимость
- Протокол не реализован
- Агент не может вызывать tool server
- Совместимость версий не проверяется

---

**Следующий шаг:** После завершения Lab 12 вы освоили продвинутые паттерны агентов! Рассмотрите опциональные продвинутые темы из учебника: [Глава 17: Security и Governance](../../book/17-security-and-governance/README.md) или [Глава 23: Evals в CI/CD](../../book/23-evals-in-cicd/README.md).
