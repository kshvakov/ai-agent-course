# Lab 12: Протокол Сервера Инструментов

## Цель
Научиться реализовывать серверы инструментов: протоколы stdio/HTTP, версионирование схем и архитектура сервера инструментов. В production также часто используют gRPC из-за строгого контракта и встроенных механизмов безопасности и наблюдаемости.

## Теория

### Серверы Инструментов

По мере роста агентов инструменты становятся сервисами:
- **Отдельные процессы** — Инструменты работают независимо
- **Протокольная коммуникация** — stdio, HTTP или gRPC (в production)
- **Версионирование схем** — Обработка обновлений инструментов
- **Изоляция** — Инструменты изолированы для безопасности

### Зачем нужны серверы инструментов?

**Монолитный агент (Lab 01-09):**
- Все инструменты в одном процессе
- Инструменты компилируются вместе с агентом
- Сложно обновлять инструменты по отдельности

**Архитектура с сервером инструментов (Lab 12):**
- Инструменты в отдельных процессах
- Инструменты можно обновлять без пересборки агента
- Лучшая безопасность (инструменты изолированы)
- Инструменты могут быть написаны на разных языках

### Протоколы

**stdio Protocol:**
- Простой: читать из stdin, писать в stdout
- Формат JSON request/response
- Подходит для локальных инструментов

**HTTP Protocol:**
- REST API для выполнения инструментов
- Лучше для распределённых систем
- Можно вызывать из любого места

### Версионирование схем

Инструменты развиваются со временем:
- Версия 1.0: `check_status(hostname)`
- Версия 2.0: `check_status(hostname, timeout)` — добавлен параметр

**Стратегия версионирования:**
- Каждый инструмент имеет версию
- Агент указывает требуемую версию
- Сервер инструментов проверяет совместимость
- Возвращает ошибку, если версии несовместимы

### Стандартные протоколы: MCP и A2A

В production всё чаще используются стандартные протоколы:
- **MCP (Model Context Protocol)** — открытый стандарт от Anthropic для подключения агентов к инструментам. Один протокол — любой инструмент, как USB для AI.
- **A2A (Agent-to-Agent Protocol)** — протокол от Google для межагентного взаимодействия. Решает задачу "агент ↔ агент", в то время как MCP решает "агент ↔ инструмент".

Подробнее: [Глава 18: Протоколы инструментов и Tool Servers](../../book/18-tool-protocols-and-servers/README.md)

## Задание

В файле `main.go` реализуйте сервер инструментов с поддержкой протоколов.

### Часть 1: Протокол stdio

Реализуйте `StdioToolServer`:
- Читайте запросы из stdin (формат JSON)
- Выполняйте инструменты
- Записывайте ответы в stdout (формат JSON)

**Формат запроса:**
```json
{
  "tool": "check_status",
  "version": "1.0",
  "arguments": {"hostname": "web-01"}
}
```

**Формат ответа:**
```json
{
  "success": true,
  "result": "Server is ONLINE",
  "error": null
}
```

### Часть 2: Протокол HTTP

Реализуйте `HTTPToolServer`:
- HTTP endpoint для выполнения инструментов (POST /execute)
- Формат запроса/ответа JSON
- Обработка ошибок

**Endpoint:** `POST /execute`
**Тело запроса:**
```json
{
  "tool": "check_status",
  "version": "1.0",
  "arguments": {"hostname": "web-01"}
}
```

**Ответ:**
```json
{
  "success": true,
  "result": "Server is ONLINE",
  "error": null
}
```

### Часть 3: Версионирование схем

Реализуйте `ToolDefinition` с версионированием:
- Поле версии (например, "1.0", "2.0")
- Список совместимых версий
- Проверка версий перед выполнением

**Пример:**
```go
type ToolDefinition struct {
    Name            string
    Version         string
    CompatibleWith  []string  // ["1.0", "1.1", "2.0"]
    Description     string
    Parameters      json.RawMessage
}
```

### Часть 4: Интеграция с Агентом

Реализуйте клиент инструментов на стороне агента:
- Вызывайте сервер инструментов через протокол (stdio или HTTP)
- Обрабатывайте совместимость версий
- Обработка ошибок

**Workflow агента:**
1. Агенту нужно вызвать инструмент
2. Агент отправляет запрос серверу инструментов (с указанием версии)
3. Сервер инструментов проверяет совместимость версий
4. Сервер инструментов выполняет инструмент
5. Сервер инструментов возвращает результат
6. Агент получает результат и продолжает работу

## Важно

- Всегда проверяйте совместимость версий
- Корректно обрабатывайте ошибки протокола
- Поддерживайте оба протокола: stdio и HTTP
- Инструменты должны быть изолированы (отдельные процессы)

## Критерии сдачи

✅ **Сдано:**
- Протокол stdio реализован
- Протокол HTTP реализован
- Версионирование схем работает
- Агент может вызывать сервер инструментов
- Совместимость версий проверяется
- Обработка ошибок реализована

❌ **Не сдано:**
- Нет версионирования, обновления ломают совместимость
- Протокол не реализован
- Агент не может вызывать сервер инструментов
- Совместимость версий не проверяется

---

**Следующий шаг:** После завершения Lab 12 переходите к опциональной [Lab 13: Tool Retrieval & Pipeline Building](../lab13-tool-retrieval/README.md). Также рассмотрите продвинутые темы из руководства: [Глава 17: Security и Governance](../../book/17-security-and-governance/README.md) или [Глава 23: Evals в CI/CD](../../book/23-evals-in-cicd/README.md).
