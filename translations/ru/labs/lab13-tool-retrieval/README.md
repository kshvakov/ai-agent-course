# Lab 13: Tool Retrieval & Pipeline Building (Опционально)

## Цель
Научить агента искать релевантные инструменты из большого каталога и строить пайплайны (комбинации инструментов) для сложных задач. Реализовать tool retrieval и выполнение пайплайнов.

## Теория

### Проблема: Бесконечное пространство инструментов

В Linux тысячи команд (`grep`, `awk`, `sed`, `jq`, `sort`, `uniq`, `head`, `tail` и т.д.), которые можно комбинировать в пайплайны. Нельзя передать все инструменты агенту — слишком много токенов, и модель хуже выбирает из большого списка.

**Решение:** Tool RAG (Retrieval Augmented Generation для пространства действий):
1. Храним **каталог инструментов** с метаданными (имя, описание, теги, уровень риска)
2. Перед планированием **извлекаем top-k релевантных инструментов** по задаче
3. Передаем модели только релевантные инструменты
4. Для сложных задач строим **пайплайны** (JSON DSL), комбинирующие несколько инструментов

### Как работает Tool Retrieval?

1. **Задача:** "Найди топ-10 ошибок в логах"
2. **Мысль агента:** "Мне нужны инструменты для фильтрации, сортировки и ограничения"
3. **Действие:** `search_tool_catalog("error log filter sort", top_k=5)`
4. **Результат:** Возвращает релевантные инструменты: `[grep, sort, head, ...]`
5. **Мысль агента:** "Построю пайплайн: grep → sort → head"
6. **Действие:** `execute_pipeline(pipeline_json)`

### Pipeline JSON DSL

Пайплайн — это формализованный план, описывающий:
- **Steps:** Последовательность вызовов инструментов
- **Input/Output:** Поток данных между шагами
- **Expected Output:** Что должен произвести пайплайн
- **Risk Level:** Оценка безопасности

## Задание

В `main.go` реализуйте tool retrieval и выполнение пайплайнов.

### Часть 1: Каталог инструментов

Создайте каталог инструментов с примерами Linux-подобных команд:

```go
type ToolDefinition struct {
    Name        string
    Description string
    Tags        []string
    RiskLevel   string
}

var toolCatalog = []ToolDefinition{
    {Name: "grep", Description: "Search for patterns in text", Tags: []string{"filter", "search"}},
    {Name: "sort", Description: "Sort lines of text", Tags: []string{"sort"}},
    // ... больше инструментов
}
```

### Часть 2: Поиск инструментов

Реализуйте `searchToolCatalog(query string, topK int) []ToolDefinition`, которая:
- Ищет инструменты по описанию и тегам (простое совпадение ключевых слов)
- Возвращает top-k наиболее релевантных инструментов

### Часть 3: Выполнение пайплайна

Реализуйте `executePipeline(pipelineJSON string, inputData string) (string, error)`, которая:
- Парсит pipeline JSON
- Валидирует уровень риска (отклоняет "dangerous" пайплайны)
- Выполняет шаги последовательно
- Возвращает финальный результат

### Часть 4: Интеграция в агента

1. Добавьте инструмент `search_tool_catalog` в список tools агента
2. Добавьте инструмент `execute_pipeline` в список tools агента
3. Настройте System Prompt для использования tool retrieval перед построением пайплайнов
4. Реализуйте цикл агента

### Сценарий тестирования

Запустите агента с промптом: *"Найди топ-5 строк с ошибками из логов, отсортированных по частоте"*

**Ожидание:**
- Агент вызывает `search_tool_catalog("error filter sort")`
- Получает релевантные инструменты: `[grep, sort, uniq, head]`
- Строит pipeline JSON: `grep("ERROR") → sort() → uniq(-c) → head(5)`
- Вызывает `execute_pipeline(pipeline_json, log_data)`
- Возвращает топ-5 строк с ошибками

## Важно

- Tool retrieval должен возвращать только релевантные инструменты (не все 100+ инструментов)
- Pipeline JSON должен валидироваться перед выполнением
- Опасные пайплайны должны отклоняться
- Шаги пайплайна выполняются последовательно (вывод шага N становится входом шага N+1)

## Критерии сдачи

✅ **Сдано:**
- Поиск в каталоге инструментов находит релевантные инструменты
- Агент строит pipeline JSON из нескольких инструментов
- Пайплайн выполняется корректно с последовательными шагами
- Опасные пайплайны отклоняются
- Код компилируется и работает

❌ **Не сдано:**
- Поиск инструментов не работает
- Pipeline JSON некорректен
- Выполнение пайплайна падает
- Нет валидации опасных операций

---

**Примечание:** Это опциональная лаба. После Lab 12 можно переходить к прод-темам или выполнить эту лабу для более глубокого понимания tool retrieval.

**Следующий шаг:** После успешного прохождения Lab 13 переходите к прод-темам или [Lab 14: Evals в CI](../lab14-evals-in-ci/README.md) (если доступна)

