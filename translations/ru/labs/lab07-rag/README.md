# Lab 07: RAG & Knowledge Base

## Цель
Научить агента работать с внутренней документацией (Wiki, Man pages, регламенты) перед выполнением действий. Реализовать простой поиск по базе знаний (RAG).

## Теория

### Проблема: Агент не знает локальные инструкции

Обычный агент знает только то, чему его научили при тренировке (до даты cut-off). Он не знает ваши локальные инструкции типа "Как перезагружать сервер Phoenix согласно регламенту №5".

**RAG (Retrieval Augmented Generation)** — это механизм "подглядывания в шпаргалку". Агент сначала ищет информацию в базе знаний, а потом действует.

### Как работает RAG?

1. **Задача:** "Перезагрузи сервер Phoenix согласно регламенту"
2. **Мысль агента:** "Я не знаю регламент. Надо поискать"
3. **Действие:** `search_knowledge_base("Phoenix restart protocol")`
4. **Результат:** "Файл `protocols.txt`: ...сначала выключить балансировщик, потом сервер..."
5. **Мысль агента:** "Ага, понял. Сначала выключаю балансировщик..."

### Простой RAG vs Векторный поиск

В этой лабе мы реализуем **простой RAG** (поиск по ключевым словам). В продакшене используется **векторный поиск** (Semantic Search), который ищет по смыслу, а не по словам.

### Продвинутые техники RAG

В production базовый RAG дополняется техниками из Advanced RAG:

- **Query Transformation** — переписывание запроса перед поиском (Query Rewriting, Sub-Query Decomposition, HyDE)
- **Routing** — маршрутизация запроса к нужному источнику данных (wiki, SQL, metrics API)
- **Hybrid Search** — комбинация keyword-поиска (BM25) и векторного поиска с Reciprocal Rank Fusion
- **Reranking** — переранжирование результатов через cross-encoder или LLM для повышения точности
- **Self-RAG** — модель сама оценивает качество найденных документов и решает: ответить, уточнить запрос или искать ещё

Подробнее: [Глава 06: RAG и База знаний](../../book/06-rag/README.md)

## Задание

В `main.go` реализуйте систему RAG для агента.

### Часть 1: База знаний

Создайте простую базу знаний (map[string]string):

```go
var knowledgeBase = map[string]string{
    "restart_policy.txt": "POLICY #12: Before restarting any server, you MUST run 'backup_db'. Failure to do so is a violation.",
    "backup_guide.txt":   "To run backup, use tool 'run_backup'. It takes no arguments.",
}
```

### Часть 2: Инструмент поиска

Реализуйте функцию `searchKnowledgeBase(query string) string`, которая:
- Ищет документы по ключевым словам (простой поиск по подстроке)
- Возвращает найденные документы или "No documents found"

### Часть 3: Интеграция в агента

1. Добавьте инструмент `search_knowledge_base` в список tools агента
2. Настройте System Prompt так, чтобы агент **всегда** искал в базе знаний перед действиями, связанными с регламентами
3. Реализуйте цикл агента (как в Lab 04)

### Сценарий тестирования

Запустите агента с промптом: *"Перезагрузи сервер Phoenix согласно регламенту"*

**Ожидание:**
- Агент вызывает `search_knowledge_base("Phoenix restart")`
- Находит документ с регламентом
- Следует инструкциям из документа (например, сначала делает backup)
- Выполняет перезагрузку

## Важно

- System Prompt должен быть строгим: "BEFORE any action, you MUST search knowledge base"
- Результат поиска должен быть добавлен в историю сообщений (role: "tool")
- Агент должен следовать найденным инструкциям

## Критерии сдачи

✅ **Сдано:**
- Агент ищет в базе знаний перед действием
- Поиск находит релевантные документы
- Агент следует найденным инструкциям
- Код компилируется и работает

❌ **Не сдано:**
- Агент не ищет в базе знаний
- Поиск не работает
- Агент игнорирует найденную информацию

---

**Следующий шаг:** После успешного прохождения Lab 07 переходите к [Lab 08: Multi-Agent](../lab08-multi-agent/README.md)
