# 12. Углублённое изучение: Прод-готовность агентов

## Зачем это нужно?

Вы прошли базовый курс и создали рабочего агента. Но что дальше? Как перейти от "учебного агента" к "прод-агенту", который работает надёжно, безопасно и эффективно в реальной среде?

Эта глава — **практическое руководство по прод-готовности**. Здесь собраны темы, которые почти всегда появляются при создании прод-агентов, но не всегда очевидны на старте. Каждая тема содержит:
- **Критерии "когда это нужно"** — чтобы понять, нужна ли вам эта тема прямо сейчас
- **Пошаговые рецепты внедрения** — что именно делать и куда это встраивать в ваш код
- **Типовые ошибки и решения** — чтобы не наступать на те же грабли
- **Чек-листы готовности** — чтобы проверить, что всё работает

### Реальный кейс

**Ситуация:** Вы создали агента для DevOps, он работает локально. Вы запускаете его в продакшен, и через неделю:
- Агент выполнил операцию, которая стоила $500 из-за большого количества токенов
- Вы не можете понять, почему агент принял неправильное решение — нет логов
- Агент завис на задаче и не отвечал 10 минут
- Пользователь пожаловался, что агент не запросил подтверждение перед удалением данных

**Проблема:** Учебный агент работает, но не готов к продакшену. Нет observability, контроля стоимости, обработки ошибок, политик безопасности.

**Решение:** Эта глава показывает, как внедрить все необходимые прод-блоки. Каждая тема — это полноценный документ с рецептами, привязанными к вашему коду из лабораторных работ.

## Как пользоваться этой главой?

### Режим 1: Срочно в прод за 1 день (минимальный набор)

Если вам нужно запустить агента в прод **прямо сейчас**, начните с этих трёх тем:

1. **[Observability и Tracing](observability.md)** — без этого вы слепы. Нужно сразу.
2. **[Cost & Latency Engineering](cost_latency.md)** — критично для контроля бюджета.
3. **[Безопасность и Governance](security_governance.md)** — обязательный прод-блок.

Эти три темы дадут вам базовую прод-готовность: вы будете видеть, что происходит, контролировать стоимость и защищать систему.

### Режим 2: Плановая доводка за 1–2 недели (расширенный набор)

Если у вас есть время на плановую доработку, добавьте темы по мере роста:

**Неделя 1:**
- [Workflow и State Management](workflow_state.md) — когда агенты выполняют долгие задачи
- [Prompt и Program Management](prompt_program_mgmt.md) — когда промпты меняются часто
- [Evals в CI/CD](evals_in_cicd.md) — автоматическая проверка качества

**Неделя 2:**
- [Data и Privacy](data_privacy.md) — если работаете с персональными данными
- [RAG в продакшене](rag_in_prod.md) — если используете RAG
- [Multi-Agent в продакшене](multi_agent_in_prod.md) — если используете Multi-Agent системы
- [Модель и декодинг](model_and_decoding.md) — выбор модели и настройка параметров

## Темы для углублённого изучения

### Обязательные прод-блоки (нужны сразу)

#### [Observability и Tracing](observability.md)
**Когда нужно:** Сразу, как только агент выходит в прод. Без observability вы не можете понять, что происходит с агентом.

**Что внутри:** Структурированное логирование, трейсинг agent runs и tool calls, метрики (latency, token usage, error rate), кореляция логов через `run_id`.

**Связь с кодом:** Привязка к `labs/lab04-autonomy/main.go` (agent loop) и `labs/lab02-tools/main.go` (tool execution).

#### [Cost & Latency Engineering](cost_latency.md)
**Когда нужно:** Когда агент используется активно или работает с большими контекстами. Критично для контроля бюджета и производительности.

**Что внутри:** Бюджеты токенов, лимиты итераций, кэширование, fallback-модели, батчинг, таймауты.

**Связь с кодом:** Привязка к `labs/lab09-context-optimization/main.go` (подсчёт токенов) и `labs/lab04-autonomy/main.go` (ReAct loop).

#### [Безопасность и Governance](security_governance.md)
**Когда нужно:** Сразу, как только агент выходит в прод. Безопасность — это не опция, а обязательное требование.

**Что внутри:** Threat modeling для tool-агентов, risk scoring, prompt injection защита, RBAC к инструментам, dry-run режимы, аудит.

**Связь с кодом:** Привязка к `labs/lab05-human-interaction/main.go` (подтверждения) и `labs/lab06-incident/SOLUTION.md` (детерминизм через SOP).

### Темы по мере роста

#### [Workflow и State Management](workflow_state.md)
**Когда нужно:** Когда агенты выполняют долгие задачи (минуты или часы), нужна идемпотентность или обработка ошибок с retry.

**Что внутри:** Идемпотентность инструментов, retries с экспоненциальным backoff, дедлайны, очереди и асинхронность, persist state.

**Связь с кодом:** Привязка к `labs/lab04-autonomy/main.go` (agent loop) и `labs/lab06-incident/main.go` (долгие задачи).

#### [Prompt и Program Management](prompt_program_mgmt.md)
**Когда нужно:** Когда промпты меняются часто, есть несколько версий или нужен A/B тестинг.

**Что внутри:** Версионирование промптов, промпт-регрессии через evals, конфиги и feature flags, A/B тестинг.

**Связь с кодом:** Привязка к `labs/lab06-incident/SOLUTION.md` (SOP в промптах) и `labs/lab09-context-optimization/main.go` (параметры модели).

#### [Evals в CI/CD](evals_in_cicd.md)
**Когда нужно:** Когда промпты или код меняются часто и нужна автоматическая проверка качества.

**Что внутри:** Quality gates в CI/CD, версионирование датасетов, обработка flaky-кейсов, тесты на безопасность.

**Связь с кодом:** Привязка к [Главе 09: Evals и Надежность](../09-evals-and-reliability/README.md).

### Специализированные темы

#### [Data и Privacy](data_privacy.md)
**Когда нужно:** Когда агент работает с персональными данными (PII) или секретами.

**Что внутри:** Обнаружение и маскирование PII, защита секретов, redaction логов, хранение и TTL логов.

**Связь с кодом:** Привязка к `labs/lab05-human-interaction/main.go` (обработка пользовательского ввода).

#### [RAG в продакшене](rag_in_prod.md)
**Когда нужно:** Если используете RAG (см. [Главу 07](../07-rag/README.md)) и нужна надёжность в проде.

**Что внутри:** Версионирование документов, freshness (актуальность), реранкинг, grounding, отказоустойчивость retrieval.

**Связь с кодом:** Привязка к `labs/lab07-rag/main.go` (RAG реализация).

#### [Multi-Agent в продакшене](multi_agent_in_prod.md)
**Когда нужно:** Если инструментов много (20+) или задачи разнородные (DevOps + Security + Data). Multi-Agent системы помогают разделить ответственность и изолировать контексты.

**Что внутри:** Supervisor/Worker и изоляция контекста, маршрутизация задач, контуры безопасности, наблюдаемость цепочки.

**Связь с кодом:** Привязка к `labs/lab08-multi-agent/main.go` (Multi-Agent система).

#### [Модель и декодинг](model_and_decoding.md)
**Когда нужно:** Сразу, на этапе выбора модели и настройки параметров. Неправильный выбор модели или параметров декодинга — частая причина проблем.

**Что внутри:** Capability benchmark перед разработкой, детерминизм (Temperature = 0), structured outputs / JSON mode, выбор модели под задачу.

**Связь с кодом:** Привязка к `labs/lab00-capability-check/main.go` (benchmark) и `labs/lab06-incident/SOLUTION.md` (детерминизм).

## Алгоритм приоритизации

Не пытайтесь изучить всё сразу. Используйте этот алгоритм:

1. **Начните с обязательных прод-блоков:**
   - Observability (логирование, трейсинг) — нужно сразу, без этого вы слепы
   - Cost & latency engineering — критично, если агент используется активно
   - Безопасность и Governance — обязательный прод-блок

2. **Добавьте темы по мере роста:**
   - Workflow/state — когда агенты выполняют долгие задачи или нужна идемпотентность
   - Политики доступа — когда несколько пользователей или разные уровни доступа
   - Prompt/program management — когда промпты меняются часто или есть несколько версий

3. **Специализированные темы:**
   - RAG в проде — если используете RAG (см. [Главу 07](../07-rag/README.md))
   - Data/privacy — если работаете с персональными данными
   - Multi-Agent в проде — если используете Multi-Agent системы


## Связь с другими главами

- **Безопасность:** Базовые концепции безопасности изучены в [Главе 06: Безопасность и Human-in-the-Loop](../06-safety-and-hitl/README.md)
- **RAG:** Базовые концепции RAG изучены в [Главе 07: RAG и База Знаний](../07-rag/README.md)
- **Multi-Agent:** Базовые концепции Multi-Agent изучены в [Главе 08: Multi-Agent Systems](../08-multi-agent/README.md)
- **Evals:** Базовые концепции evals изучены в [Главе 09: Evals и Надежность](../09-evals-and-reliability/README.md)
- **Best Practices:** Общие практики изучены в [Главе 11: Best Practices](../11-best-practices/README.md)
- **Физика LLM:** Фундаментальные концепции изучены в [Главе 01: Физика LLM](../01-llm-fundamentals/README.md)
- **Инструменты:** Function Calling изучен в [Главе 04: Инструменты и Function Calling](../04-tools-and-function-calling/README.md)
- **Приложение:** Справочники, шаблоны и Capability Benchmark в [Приложении](../appendix/README.md)

---

**Навигация:** [← Best Practices](../11-best-practices/README.md) | [Оглавление](../README.md) | [Приложение →](../appendix/README.md)
