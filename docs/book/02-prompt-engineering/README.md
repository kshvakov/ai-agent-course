# 02. Промптинг как инженерная дисциплина

Промпт — это код для нейросети. Но в отличие от обычного кода, промпт работает через управление вероятностями.

## Структура System Prompt

Хороший System Prompt состоит из блоков:

```text
1. Role (Persona)
2. Goal (Цель)
3. Constraints (Ограничения)
4. Format (Формат ответа)
5. SOP (Standard Operating Procedure)
```

### Пример для DevOps

```text
Ты Senior DevOps Engineer с 10-летним опытом.

Твоя цель — восстановить работоспособность сервисов максимально быстро.

Ограничения:
- Никогда не используй команды типа `rm -rf /`
- Всегда спрашивай подтверждение перед удалением данных
- Если не уверен в действии — спроси у пользователя

Формат ответа:
- Если нужно вызвать инструмент — используй Tool Calling
- Если нужно уточнить — отвечай текстом

SOP для инцидентов:
1. Проверь статус сервиса (check_http)
2. Если не 200 — читай логи (read_logs)
3. Анализируй ошибки
4. Применяй фикс (restart/rollback)
5. Верифицируй (check_http снова)
```

### Пример для Support

```text
Ты Customer Support Agent уровня Tier 2.

Твоя цель — решить проблему пользователя быстро и вежливо.

Ограничения:
- Всегда будь вежлив
- Если проблема сложная — эскалируй
- Не давай технических деталей, если пользователь не технарь

SOP для обработки тикета:
1. Прочитай тикет полностью (get_ticket)
2. Собери контекст (версия ПО, ОС, браузер)
3. Поищи в базе знаний (search_kb)
4. Если решение найдено — сформулируй ответ
5. Если нет — эскалируй (escalate_ticket)
```

### Пример для Data Analytics

```text
Ты Data Analyst с опытом работы с SQL и BI-инструментами.

Твоя цель — предоставить точные данные и аналитику.

Ограничения:
- Используй ТОЛЬКО read-only SQL (SELECT)
- Всегда проверяй качество данных перед анализом
- Если данные некорректны — сообщи об этом

SOP для анализа:
1. Понять вопрос пользователя
2. Сформулировать SQL-запрос
3. Проверить схему таблицы (describe_table)
4. Выполнить запрос (sql_select)
5. Проанализировать результаты
6. Сгенерировать отчет
```

## In-Context Learning (ICL)

**In-Context Learning** — это способность модели обучаться на примерах *внутри промпта*, без переобучения весов.

### Zero-Shot (без примеров)

```text
User: Check logs.
Agent: [Модель должна сама догадаться, что делать]
```

**Проблема:** Модель может "не понять" формат или сделать не то.

### Few-Shot (с примерами)

```text
User: Check logs.
Agent: {"tool": "read_logs", "args": {"service": "nginx"}}

User: Restart server.
Agent: {"tool": "restart", "args": {"name": "web-01"}}

User: Check status.
Agent: [Модель копирует паттерн]
```

**Почему это работает?**

Механизм **Self-Attention** в трансформере "копирует" паттерн из примеров. Векторное представление токенов смещается в сторону нужного формата, потому что предыдущие токены задали этот контекст.

**Практический пример (Support):**

```text
Пример 1:
User: "Мой аккаунт заблокирован"
Agent: {"action": "check_account", "user_id": "extract_from_ticket"}

Пример 2:
User: "Не могу войти"
Agent: {"action": "check_login", "user_id": "extract_from_ticket"}

Теперь для нового тикета:
User: "Проблема с доступом"
Agent: [Автоматически выберет правильный формат]
```

## Chain-of-Thought (CoT)

**Chain-of-Thought** — это техника "Думай по шагам".

### Почему это работает?

Представьте задачу: "Сколько будет 23 * 41 + 12?"

**Без CoT:**
- Модель должна выдать ответ "955" сразу
- Это требует огромной вычислительной мощности в одном шаге
- Вероятность ошибки высока

**С CoT:**
- Модель генерирует: "23 * 40 = 920... 23 * 1 = 23... сумма 943... плюс 12... ответ 955"
- Генерируя промежуточные токены ("920", "943"), модель **выгружает вычисления в контекст**
- Следующий токен предсказывается на основе *расширенного* контекста, содержащего промежуточные результаты
- Это превращает сложную задачу $O(N)$ в серию простых задач $O(1)$

**Для агентов CoT критичен.**

❌ **Плохо:** "Почини сервер" (один шаг)  
✅ **Хорошо:** "Проанализируй ситуацию, выдвини гипотезу, проверь её, предложи решение" (цепочка)

### Примеры CoT в разных доменах

#### DevOps
```
Thought: Пользователь жалуется на медленную работу. Начну с проверки метрик.
Action: get_cpu_metrics()
Observation: CPU 95%, процесс: ffmpeg
Thought: ffmpeg жрет ресурсы. Проверю, что это за процесс.
Action: get_process_info(pid=12345)
Observation: Это видео-конвертация, запущенная пользователем
Thought: Это легитимный процесс, но он блокирует систему. Предложу пользователю ограничить приоритет.
```

#### Security
```
Thought: Получен алерт о подозрительной активности. Начну с триажа.
Action: query_siem(query="host=192.168.1.10 AND time>now-1h")
Observation: Множество failed login attempts
Thought: Это похоже на brute-force. Проверю источник.
Action: get_source_ip()
Observation: IP из незнакомой страны
Thought: Высокий риск. Изолирую хост, но сначала запрошу подтверждение.
```

#### Data Analytics
```
Thought: Пользователь спрашивает про продажи. Нужно понять, какие данные есть.
Action: describe_table("sales")
Observation: Таблица содержит поля: date, region, amount
Thought: Теперь сформулирую SQL-запрос для получения продаж за последний месяц.
Action: sql_select("SELECT region, SUM(amount) FROM sales WHERE date > NOW() - INTERVAL '1 month' GROUP BY region")
Observation: Результаты: Region A: 100k, Region B: 150k
Thought: Проанализирую результаты и сформулирую выводы.
```

## SOP (Standard Operating Procedure) в промптах

**SOP** — это алгоритм действий, закодированный в промпте.

### Зачем это нужно?

Без SOP агент может "метаться": сразу рестартить, потом читать логи, потом опять рестартить.

### Пример SOP для инцидента (DevOps)

```text
SOP для падения сервиса:
1. Check Status: Проверь HTTP код ответа
2. Check Logs: Если 500/502 — читай последние 20 строк логов
3. Analyze: Найди ключевые слова:
   - "Syntax error" → Rollback
   - "Connection refused" → Check Database
   - "Out of memory" → Restart
4. Action: Примени фикс согласно анализу
5. Verify: Проверь HTTP статус снова
```

### Пример SOP для Support

```text
SOP для обработки тикета:
1. Read: Прочитай тикет полностью
2. Context: Собери контекст (версия, ОС, браузер)
3. Search: Поищи в базе знаний похожие случаи
4. Decide:
   - Если решение найдено → Draft reply
   - Если сложная проблема → Escalate
5. Respond: Отправь ответ пользователю
```

### Пример SOP для Security

```text
SOP для триажа алерта:
1. Severity: Определи критичность (Low/Medium/High/Critical)
2. Evidence: Собери доказательства (логи, метрики, сетевой трафик)
3. Triage:
   - Если False Positive → Close alert
   - Если True Positive → Containment (с подтверждением!)
4. Report: Сгенерируй отчет для SOC
```

## Структурирование задач (Task Decomposition)

Сложные задачи нужно разбивать на подзадачи.

### Пример: "Разберись с проблемой базы данных"

**Без декомпозиции:**
```
User: "Разберись с проблемой базы"
Agent: [Может попытаться сделать всё сразу и запутаться]
```

**С декомпозицией:**
```
User: "Разберись с проблемой базы"
Agent:
1. Проверю доступность БД (ping_db)
2. Проверю метрики (cpu, memory, connections)
3. Прочитаю логи (read_db_logs)
4. Проанализирую ошибки
5. Предложу решение
```

## Типовые ошибки промптинга

### Ошибка 1: Слишком общий промпт

❌ **Плохо:**
```text
Ты помощник.
```

✅ **Хорошо:**
```text
Ты Senior DevOps Engineer с 10-летним опытом.
Твоя цель — восстановить работоспособность сервисов.
Следуй SOP: 1. Check Status 2. Check Logs 3. Analyze 4. Fix 5. Verify
```

### Ошибка 2: Отсутствие CoT

❌ **Плохо:**
```text
Почини сервер.
```

✅ **Хорошо:**
```text
Думай по шагам:
1. Проанализируй ситуацию
2. Выдвини гипотезу
3. Проверь гипотезу
4. Примени решение
```

### Ошибка 3: Отсутствие ограничений

❌ **Плохо:**
```text
Ты DevOps инженер. Делай что нужно.
```

✅ **Хорошо:**
```text
Ты DevOps инженер.
Ограничения:
- Никогда не удаляй данные без подтверждения
- Всегда проверяй логи перед действием
```

## Чек-лист: Создание System Prompt

- [ ] Роль (Persona) четко определена
- [ ] Цель (Goal) конкретна и измерима
- [ ] Ограничения (Constraints) явно указаны
- [ ] Формат ответа (Format) описан
- [ ] SOP (если применимо) детально расписан
- [ ] CoT включен для сложных задач
- [ ] Few-Shot примеры добавлены (если нужно)

## Мини-упражнения

### Упражнение 1: Создайте System Prompt

Создайте System Prompt для агента, который обрабатывает тикеты поддержки:

```go
systemPrompt := `
// Ваш код здесь
`
```

### Упражнение 2: Добавьте CoT

Улучшите промпт, добавив Chain-of-Thought:

```go
cotPrompt := `
// Ваш код здесь
`
```

## Что дальше?

После изучения промптинга переходите к:
- **[03. Анатомия Агента](../03-agent-architecture/README.md)** — как устроен агент изнутри

---

**Навигация:** [← Физика LLM](../01-llm-fundamentals/README.md) | [Оглавление](../README.md) | [Анатомия Агента →](../03-agent-architecture/README.md)

